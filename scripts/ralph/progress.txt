US-001: Added _inference_lock to BaseDetector.__init__. Renamed abstract detect() to _detect_impl() and added a concrete detect() that wraps _detect_impl() with the lock via context manager. Updated both FaceBiSeNetDetector and YOLOv8SegDetector to call super().__init__() and renamed their detect() to _detect_impl(). py_compile passes.

US-002: Wrapped json.loads(msg) in try-except json.JSONDecodeError. On error, sends {"error": "Invalid JSON"} back to client and continues the loop. py_compile passes.

US-003: Added inner try-except Exception inside the while True loop of ws_detect. Logs errors with logger.exception() and continues the loop. WebSocketDisconnect propagates to the outer handler since it doesn't inherit from Exception in Starlette. py_compile passes.

US-004: Protected all inpaint state (inpaint_status, inpaint_status_detail, inpaint_engine) with state.lock. Updated _load_inpaint_model on_status callback, direct writes, api_status reads, and ws_inpaint engine reads. Used local `engine` variable after locked read to keep lock scopes narrow. py_compile passes.

US-005: Extracted InpaintOrchestrator class into server/inpaint_orchestrator.py. The class was already created (likely from a previous attempt) with handle_cancel(), handle_generate(), _run_generation(), and _send() methods. Refactored ws_inpaint to use the orchestrator — reduced from ~139 lines to 20 lines of message dispatch. Removed unused imports (time, io, create_inpaint_inputs) from app.py. All lock patterns from US-004 preserved in the orchestrator. py_compile passes for both files.

## US-006
- What was implemented
  - server/enums.py already existed with DetectionMode(str, Enum) and ModelStatus(str, Enum) from a previous partial attempt
  - Updated app.py to actually USE the enums: replaced all bare string comparisons for detection mode ("face", "object") with DetectionMode.FACE/OBJECT
  - Replaced all bare string assignments/comparisons for inpaint_status ("loading", "ready", "error") with ModelStatus.LOADING/READY/ERROR
  - Updated api_status to use ModelStatus for the detection status field
  - config.py DEFAULT_DETECTION_MODE left as plain string — compatible because DetectionMode(str, Enum) means "face" == DetectionMode.FACE is True
- Files changed
  - server/app.py (used enums in get_detector_sync, _load_inpaint_model, _prewarm_face_detector, AppState default, api_status)
  - server/enums.py (already existed, committed as new file)
- **Learnings for future iterations:**
  - Using (str, Enum) makes enum members behave as str subclasses — they compare equal to plain strings and serialize correctly in json.dumps without needing .value
  - No need to use .value when building dicts for JSONResponse since str enum members ARE strings
  - Dict keys with str enum members serialize correctly in JSON
  - config.py doesn't need changes when enums are str-based — plain string env var values compare equal to enum members
---

## US-007
- What was implemented
  - Created server/yolov5_compat.py with all YOLOv5-Face functions and model architecture classes extracted from vendored utils/ and models/
  - Functions: attempt_load, letterbox, check_img_size, non_max_suppression_face, scale_coords, plus transitive deps
  - Architecture classes: Conv, DWConv, StemBlock, Bottleneck, BottleneckCSP, C3, SPP, SPPF, Focus, Detect, Model, Ensemble, etc.
  - Registered sys.modules shims for old module paths so torch.load() deserialization works
  - Updated server/detection.py imports, removed sys.path hack
  - Deleted utils/ (23 files) and models/ (14 files) via git rm -rf
  - Updated Dockerfile to remove COPY lines for deleted directories
- Files changed
  - server/yolov5_compat.py (new), server/detection.py, Dockerfile, utils/ (deleted), models/ (deleted)
- **Learnings for future iterations:**
  - torch.load(weights_only=False) deserializes objects by their original module paths. Moving classes breaks loading unless you register shim modules in sys.modules.
  - Solution: types.ModuleType shims that map old paths to new class definitions.
  - _parse_model originally used dynamic string resolution for YAML configs. Replaced with safe namespace dict lookup.
  - Model.fuse() is called at load time and needs Conv + fuse_conv_and_bn as runtime deps.
  - Shims must be registered at import time (before any torch.load call).
---
